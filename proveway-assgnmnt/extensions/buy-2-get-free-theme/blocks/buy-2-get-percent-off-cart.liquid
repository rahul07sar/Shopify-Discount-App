{%- comment -%}
  App block: renders a Buy 2, get % off message on cart pages when eligible.
{%- endcomment -%}
{% assign rules = shop.metafields.custom.volume_discount_rules.value %}
{% assign rules_list = rules.rules %}

{% assign best_percent = 0 %}
{% if rules_list %}
  {% for item in cart.items %}
    {% assign item_gid = item.product.admin_graphql_api_id %}
    {% assign item_id = item.product.id | append: "" %}
    {% for rule in rules_list %}
      {% if rule.products %}
        {% assign rule_match = false %}
        {% for rule_id in rule.products %}
          {% if item_gid and rule_id == item_gid %}
            {% assign rule_match = true %}
            {% break %}
          {% endif %}
          {% if item_id != blank %}
            {% assign rule_numeric = rule_id | split: "/" | last %}
            {% if rule_numeric == item_id %}
              {% assign rule_match = true %}
              {% break %}
            {% endif %}
          {% endif %}
        {% endfor %}
        {% if rule_match %}
          {% assign rule_percent = rule.percentOff | plus: 0 %}
          {% if rule_percent > best_percent %}
            {% assign best_percent = rule_percent %}
          {% endif %}
        {% endif %}
      {% endif %}
    {% endfor %}
  {% endfor %}
{% elsif rules and rules.products %}
  {% for item in cart.items %}
    {% assign item_gid = item.product.admin_graphql_api_id %}
    {% assign item_id = item.product.id | append: "" %}
    {% assign rule_match = false %}
    {% for rule_id in rules.products %}
      {% if item_gid and rule_id == item_gid %}
        {% assign rule_match = true %}
        {% break %}
      {% endif %}
      {% if item_id != blank %}
        {% assign rule_numeric = rule_id | split: "/" | last %}
        {% if rule_numeric == item_id %}
          {% assign rule_match = true %}
          {% break %}
        {% endif %}
      {% endif %}
    {% endfor %}
    {% if rule_match %}
      {% assign rule_percent = rules.percentOff | plus: 0 %}
      {% if rule_percent > best_percent %}
        {% assign best_percent = rule_percent %}
      {% endif %}
    {% endif %}
  {% endfor %}
{% endif %}

{% if best_percent > 0 %}
  <div
    class="buy-2-get-percent-off"
    style="padding: 12px 16px; border: 1px solid #e1e3e5; border-radius: 8px; background: #f6f6f7;"
  >
    Buy 2, get {{ best_percent }}% off
  </div>
{% endif %}

{% schema %}
{
  "name": "Buy 2, get % off (Cart)",
  "target": "section",
  "templates": ["cart"],
  "settings": []
}
{% endschema %}
