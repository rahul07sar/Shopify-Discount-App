{%- comment -%}
  App block: renders a Buy 2, get % off message when the current product is eligible.
{%- endcomment -%}
{% assign rules_raw = shop.metafields.custom.volume_discount_rules.value %}
{% assign rules_parsed = rules_raw | parse_json %}
{% assign rules = rules_parsed | default: rules_raw %}
{% assign product_gid = product.admin_graphql_api_id %}
{% assign product_id = product.id | append: "" %}
{% assign rules_list = rules.rules %}
{% if rules_list == blank and rules.products %}
  {% assign rules_list = "" | split: "," %}
  {% assign rules_list = rules_list | push: rules %}
{% endif %}

{% assign best_percent = 0 %}
{% if rules_list %}
  {% for rule in rules_list %}
    {% if rule.products %}
      {% assign rule_match = false %}
      {% for rule_id in rule.products %}
        {% if product_gid and rule_id == product_gid %}
          {% assign rule_match = true %}
          {% break %}
        {% endif %}
        {% if product_id != blank %}
          {% assign rule_numeric = rule_id | split: "/" | last %}
          {% if rule_numeric == product_id %}
            {% assign rule_match = true %}
            {% break %}
          {% endif %}
        {% endif %}
      {% endfor %}
      {% if rule_match %}
        {% assign rule_percent = rule.percentOff | plus: 0 %}
        {% if rule_percent > best_percent %}
          {% assign best_percent = rule_percent %}
        {% endif %}
      {% endif %}
    {% endif %}
  {% endfor %}
{% endif %}

{% if best_percent > 0 %}
  <div
    class="buy-2-get-percent-off"
    style="padding: 12px 16px; border: 1px solid #e1e3e5; border-radius: 8px; background: #f6f6f7;"
  >
    Buy 2, get {{ best_percent }}% off
  </div>
{% endif %}

{% schema %}
{
  "name": "Buy 2, get % off",
  "target": "section",
  "templates": ["product"],
  "settings": []
}
{% endschema %}
